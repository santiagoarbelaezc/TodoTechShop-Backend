plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.5'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'jacoco'
}

group = 'co'
version = '0.0.1-SNAPSHOT'
description = 'TodoTech'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // âœ… DEPENDENCIAS PRINCIPALES (OPTIMIZADAS)
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web'

    // âŒ REMOVIDO temporalmente para reducir memoria
    // implementation 'org.springframework.boot:spring-boot-starter-actuator'
    // implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
    // implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'

    // PARA CARGAR .env
    implementation 'io.github.cdimascio:dotenv-java:3.0.2'

    // SPRING MAIL
    implementation 'org.springframework.boot:spring-boot-starter-mail'

    // SPRING RETRY
    implementation 'org.springframework.retry:spring-retry:2.0.12'
    implementation 'org.springframework:spring-aspects:6.2.5'

    // JWT Auth0
    implementation 'com.auth0:java-jwt:4.4.0'

    // STRIPE - PASARELA DE PAGOS
    implementation 'com.stripe:stripe-java:24.0.0'

    // MapStruct
    implementation 'org.mapstruct:mapstruct:1.6.3'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.6.3'

    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

    // IntegraciÃ³n Lombok + MapStruct
    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'

    runtimeOnly 'org.postgresql:postgresql'

    // âœ… DEPENDENCIAS DE TESTING OPTIMIZADAS
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testImplementation 'org.mockito:mockito-core'
    testImplementation 'org.mockito:mockito-junit-jupiter'
    testCompileOnly 'org.projectlombok:lombok'
    testAnnotationProcessor 'org.projectlombok:lombok'
    testImplementation 'com.h2database:h2'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

// ==================== âœ… CONFIGURACIÃ“N JVM OPTIMIZADA ====================

bootJar {
    archiveFileName = 'todotech-application.jar'
    // âŒ REMOVIDO: layered configuration que causaba error
}

jar {
    enabled = false
}

// âœ… CONFIGURACIÃ“N JACOCO OPTIMIZADA
jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                    '**/config/**',
                    '**/dto/**',
                    '**/exception/**',
                    '**/model/**',
                    '**/TodoTechApplication.class'
            ])
        }))
    }
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.70
            }
        }
    }
}

// ==================== âœ… CONFIGURACIÃ“N DE COMPILACIÃ“N OPTIMIZADA ====================

tasks.withType(JavaCompile) {
    options.compilerArgs = [
            '-Amapstruct.suppressGeneratorTimestamp=true',
            '-Amapstruct.defaultComponentModel=spring',
            '-Amapstruct.unmappedTargetPolicy=IGNORE',
            '-parameters' // âœ… Mejora rendimiento de Spring
    ]
    options.encoding = 'UTF-8'
    options.fork = true
}

// ==================== âœ… CONFIGURACIÃ“N DE TESTS OPTIMIZADA ====================

test {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "short" // âœ… Cambiado de "full" a "short" para menos logs
    }

    // âœ… CONFIGURACIÃ“N DE MEMORIA PARA TESTS (REDUCIDA)
    minHeapSize = "256m"
    maxHeapSize = "512m"

    // âœ… JVM ARGS ESPECÃFICOS PARA TESTS
    jvmArgs = [
            '-XX:+UseG1GC',
            '-Xmx512m',
            '-Xms256m'
    ]

    if (System.getenv('CI')) {
        failFast = true
    }

    finalizedBy jacocoTestReport
}

// ==================== âœ… CONFIGURACIÃ“N CRÃTICA PARA PRODUCCIÃ“N ====================

// âœ… TAREA BOOTRUN OPTIMIZADA PARA DESARROLLO LOCAL
bootRun {
    // âœ… JVM ARGS PARA REDUCIR MEMORIA EN DESARROLLO
    jvmArgs = [
            '-Xmx512m',
            '-Xms256m',
            '-XX:MaxMetaspaceSize=256m',
            '-XX:+UseG1GC',
            '-XX:+PrintGC',
            '-XX:+PrintGCDateStamps',
            '-Dspring.jmx.enabled=false', // âœ… Deshabilita JMX - ahorra memoria
            '-Dspring.main.lazy-initialization=true' // âœ… Lazy initialization - CRÃTICO
    ]

    systemProperties System.properties
}

// ==================== âœ… TAREAS PERSONALIZADAS OPTIMIZADAS ====================

tasks.register('buildForDeploy') {
    group = 'Build'
    description = 'Build optimized JAR for deployment'
    dependsOn bootJar

    doLast {
        println "âœ… JAR built with memory-optimized settings"
        println "ðŸ“ JAR location: ${bootJar.archiveFile.get()}"
        println "ðŸ“¦ JAR size: ${file(bootJar.archiveFile.get()).length() / (1024 * 1024)} MB"
    }
}

tasks.register('verifyJar', Exec) {
    group = 'Verification'
    description = 'Verify JAR has correct main class'
    dependsOn bootJar

    commandLine 'java', '-jar', bootJar.archiveFile.get(), '--version'
    ignoreExitValue = true

    doLast {
        if (execResult.exitValue == 0) {
            println "âœ… JAR verification successful"
        } else {
            println "âŒ JAR verification failed"
        }
    }
}

// âœ… TAREA PARA VER CONFIGURACIÃ“N DE MEMORIA
tasks.register('showMemoryConfig') {
    group = 'Help'
    description = 'Show current memory configuration'

    doLast {
        println "=== MEMORY CONFIGURATION ==="
        println "Test - Min: 256m, Max: 512m"
        println "BootRun - Min: 256m, Max: 512m"
        println "Production JVM: -Xmx512m -Xms256m -XX:+UseG1GC"
        println "============================"
    }
}

// âœ… LIMPIEZA OPTIMIZADA
clean {
    delete 'build'
    delete 'out'
    delete 'logs'
}

// âœ… CONFIGURACIÃ“N PARA PROCESAMIENTO DE RECURSOS
processResources {
    from('.') {
        include '.env'
        into 'resources'
    }
    // âœ… Comprimir recursos
    filesMatching('**/*.properties') {
        filter { line ->
            line.replace('${', '\\${') // Escapar placeholders
        }
    }
}

// ==================== âœ… CONFIGURACIÃ“N PARA DIFERENTES ENTORNOS ====================

// Tarea especÃ­fica para producciÃ³n
tasks.register('productionBuild') {
    group = 'Build'
    description = 'Build with production optimizations'
    dependsOn bootJar

    doLast {
        println "ðŸš€ Production build ready with:"
        println "   - Memory limits: 512MB max"
        println "   - G1 Garbage Collector"
        println "   - Lazy initialization enabled"
        println "   - DevTools disabled"
    }
}